@model IEnumerable<TesoreriaVS12.Areas.Tesoreria.Models.Ma_CompromisosModel>

@{
    ViewBag.Title = "AutorizacionCompromisos";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div id="_menu_lateral">
    @{ Html.RenderAction("Botonera", "Home", new { Area = "", ids = new List<object> { "bSalir" } }); }
</div>
<h2>Autorización de Compromisos</h2>
<table id="tablaCompromisos" class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>Tipo</th>
            <th>Folio</th>
            <th>Fecha</th>
            <th>Proveedor</th>
            <th>Importe</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>@Html.DisplayFor(modelItem => item.Id_TipoCompromiso)</td>
                <td>@Html.DisplayFor(modelItem => item.Id_FolioCompromiso)</td>
                <td>@Html.Encode(String.Format("{0:d/MM/yyyy}", item.Fecha_Orden.Value))</td>
                <td>@Html.DisplayFor(modelItem => item.Ca_Beneficiarios.NombreCompleto)</td>
                <td>@String.Format("{0:C}", item.Cargos)</td>
                <td class="text-center acciones">
                    <a data-placement="top" data-toggle="tooltip" title="Mostrar Compromiso" data-id="@item.Id_TipoCompromiso,@item.Id_FolioCompromiso" class="fa fa-file-text-o js_mostrarCompromiso"></a>
                    <a data-placement="top" data-toggle="tooltip" title="Partidas Sin Disponibilidad" data-id="@item.Id_TipoCompromiso,@item.Id_FolioCompromiso" class="fa fa-search js_verPartidas"></a>
                    <a data-placement="top" data-toggle="tooltip" title="Rechazar Compromiso" data-id="@item.Id_TipoCompromiso,@item.Id_FolioCompromiso" class="fa fa-times js_rechazar"></a>
                </td>
            </tr>
        }

    </tbody>
</table>
@using (Html.BeginForm("OrdenCompra", "Compromisos", FormMethod.Post, new { id = "frmConsultaCompromiso" }))
{
}
@section Scripts{
    <script src="~/Scripts/jquery.validate.min.js"></script>
    <script src="~/Scripts/jquery.validate.unobtrusive.min.js" class="jsValidate"></script>
    <script type="text/javascript">
        var tablaCompromisos = "";
        var idTipo = "";
        var idFolio = "";
        var pos = "";
        $(document).on("ready", function () {
            $("[data-toggle='tooltip']").tooltip();
            tablaCompromisos = ConstruirTabla("tablaCompromisos","No se encontraron registros");
            $("body").on("click", ".js_verPartidas", function () {
                pos = tablaCompromisos.fnGetPosition($(this).closest('tr').get(0));
                var cadena = $(this).data("id").split(",");
                idTipo = cadena[0];
                idFolio = cadena[1];
                ajaxLoad("@Url.Action("GetPartidasSinDisponibilidad","Egresos")", { idTipoCompromiso: idTipo, idFolioCompromiso: idFolio }, "modal-body1", "POST", function () {
                    openModal({ Modal: "MyModal1", Size: "lg" });
                    ConstruirTabla("tabla_compromisos","No se encontraron registros",2);
                    $(".js_btnOk").remove();
                });
            });
            $(".js_mostrarCompromiso").on("click", function () {
                var cadena = $(this).data("id").split(",");
                idTipo = cadena[0];
                idFolio = cadena[1];
                ajaxJson("@Url.Action("ConsultarCompromisos","Egresos")", { TipoCompromiso: idTipo, FolioCompromiso: idFolio }, "POST", true, function (response) {
                    if (!response.Exito)
                        ErrorCustom(response.Mensaje);
                    else {
                        llamarMaestro("frmConsultaCompromiso", response.Parametros);
                    }
                });
            });
            $(document).on("click", "#btnAutorizar", function () {
                ajaxJson("@Url.Action("AutorizarPartidas","Egresos")", { idTipoCompromiso: idTipo, idFolioCompromiso: idFolio }, "POST", true, function (datos) {
                    if (datos.Exito == true) {
                        closeModal();
                        tablaCompromisos.fnDeleteRow(pos);
                        ExitoCustom("Las partidas se han autorizado con éxito");
                    }
                    else
                        ErrorCustom(datos.Mensaje);
                });
            });
            $("body").on("click", ".js_rechazar", function () {
                pos = tablaCompromisos.fnGetPosition($(this).closest('tr').get(0));
                var cadena = $(this).data("id").split(",");
                idTipo = cadena[0];
                idFolio = cadena[1];
                ConfirmCustom("¿Está seguro de rechazar este compromiso?", function () {
                    ajaxJson("@Url.Action("RechazarCompromiso","Egresos")", { idTipoCompromiso: idTipo, idFolioCompromiso: idFolio }, "POST", true, function (data) {
                        if (data.Exito == true) {
                            tablaCompromisos.fnDeleteRow(pos);
                            ExitoCustom("Compromiso rechazado correctamente");
                        } else
                            ErrorCustom(datos.Mensaje);
                    });
                }, "", "Si", "No");
            });
            $("body").on("click", "#js_mSalir", function () {
                GoHome();
            });
        });
    </script>
}